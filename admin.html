<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>학생 관리 - MathMore</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Noto Sans KR', -apple-system, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { color: #333; margin-bottom: 24px; }

        /* 학생 등록 섹션 */
        .grant-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .grant-section h2 { font-size: 18px; margin-bottom: 16px; color: #333; }
        .grant-form {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        .form-group { display: flex; flex-direction: column; gap: 4px; }
        .form-group label { font-size: 12px; color: #666; }
        .form-group input {
            padding: 10px 14px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        .form-group input:focus {
            outline: none;
            border-color: #8b7d6b;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .btn:hover { opacity: 0.85; }
        .btn-primary { background: #8b7d6b; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }

        /* 학생 목록 */
        .users-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .users-section h2 { font-size: 18px; margin-bottom: 16px; color: #333; }
        .search-box {
            margin-bottom: 16px;
        }
        .search-box input {
            width: 100%;
            max-width: 300px;
            padding: 10px 14px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th { color: #666; font-size: 12px; font-weight: 600; text-transform: uppercase; }
        td { font-size: 14px; color: #333; }
        .status-active { color: #28a745; font-weight: 600; }
        .status-inactive { color: #dc3545; font-weight: 600; }

        /* 로딩 & 메시지 */
        .loading { text-align: center; padding: 40px; color: #666; }
        .message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }
        .message.success { background: #d4edda; color: #155724; }
        .message.error { background: #f8d7da; color: #721c24; }

        /* 로그인 필요 */
        .login-required {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 12px;
        }
        .login-required h2 { margin-bottom: 16px; }
        .login-required p { color: #666; margin-bottom: 24px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>학생 관리</h1>
        <div id="message"></div>
        <div id="content">
            <div class="loading">로딩 중...</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://bdunrluoivhgypwangcx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJkdW5ybHVvaXZoZ3lwd2FuZ2N4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyNjc1NTksImV4cCI6MjA4Mjg0MzU1OX0.JBkLVuR8RyOmwMl6_-KPIgsYBy1_qoG90v5j_vt0mSQ';

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let allStudents = [];

        // 초기화
        async function init() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                showLoginRequired();
                return;
            }

            currentUser = session.user;

            // profiles에서 role 확인
            const { data: profile } = await supabaseClient
                .from('profiles')
                .select('role')
                .eq('id', currentUser.id)
                .single();

            if (profile?.role !== 'admin') {
                showAccessDenied();
                return;
            }

            await loadDashboard();
        }

        function showLoginRequired() {
            document.getElementById('content').innerHTML = `
                <div class="login-required">
                    <h2>로그인이 필요합니다</h2>
                    <p>관리자 페이지에 접근하려면 로그인해주세요.</p>
                    <button class="btn btn-primary" onclick="login()">Google로 로그인</button>
                </div>
            `;
        }

        function showAccessDenied() {
            document.getElementById('content').innerHTML = `
                <div class="login-required">
                    <h2>접근 권한이 없습니다</h2>
                    <p>관리자만 접근할 수 있습니다.</p>
                    <button class="btn btn-primary" onclick="logout()">로그아웃</button>
                </div>
            `;
        }

        async function login() {
            await supabaseClient.auth.signInWithOAuth({
                provider: 'google',
                options: { redirectTo: window.location.href }
            });
        }

        async function logout() {
            await supabaseClient.auth.signOut();
            window.location.reload();
        }

        async function loadDashboard() {
            document.getElementById('content').innerHTML = `
                <div class="grant-section">
                    <h2>학생 등록</h2>
                    <div class="grant-form">
                        <div class="form-group">
                            <label>이메일</label>
                            <input type="email" id="grant-email" placeholder="student@example.com" style="width: 300px;">
                        </div>
                        <button class="btn btn-primary" onclick="grantAccess()">무료 이용 권한 부여</button>
                    </div>
                </div>

                <div class="users-section">
                    <h2>학생 목록</h2>
                    <div class="search-box">
                        <input type="text" id="search" placeholder="이메일로 검색..." oninput="filterStudents()">
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>이메일</th>
                                <th>상태</th>
                                <th>등록일</th>
                                <th>관리</th>
                            </tr>
                        </thead>
                        <tbody id="students-table">
                            <tr><td colspan="4" class="loading">로딩 중...</td></tr>
                        </tbody>
                    </table>
                </div>
            `;

            await loadStudents();
        }

        async function loadStudents() {
            try {
                const { data, error } = await supabaseClient
                    .from('user_purchases_with_email')
                    .select('*')
                    .eq('role', 'student')
                    .order('purchased_at', { ascending: false });

                if (error) throw error;

                allStudents = data || [];
                renderStudents(allStudents);
            } catch (error) {
                console.error('Students load error:', error);
                document.getElementById('students-table').innerHTML =
                    '<tr><td colspan="4">학생 목록을 불러올 수 없습니다.</td></tr>';
            }
        }

        function renderStudents(students) {
            const tbody = document.getElementById('students-table');

            if (students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4">등록된 학생이 없습니다.</td></tr>';
                return;
            }

            tbody.innerHTML = students.map(student => {
                const isActive = student.has_full_access === true;
                const statusClass = isActive ? 'status-active' : 'status-inactive';
                const statusText = isActive ? '활성' : '비활성';
                const purchasedAt = student.purchased_at
                    ? new Date(student.purchased_at).toLocaleDateString('ko-KR')
                    : '-';

                return `
                    <tr>
                        <td>${student.email}</td>
                        <td class="${statusClass}">${statusText}</td>
                        <td>${purchasedAt}</td>
                        <td>
                            ${isActive
                                ? `<button class="btn btn-danger btn-sm" onclick="revokeAccess('${student.user_id}')">권한 제거</button>`
                                : `<button class="btn btn-primary btn-sm" onclick="restoreAccess('${student.user_id}')">권한 부여</button>`
                            }
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterStudents() {
            const query = document.getElementById('search').value.toLowerCase();
            const filtered = allStudents.filter(s => s.email.toLowerCase().includes(query));
            renderStudents(filtered);
        }

        async function grantAccess() {
            const email = document.getElementById('grant-email').value.trim();

            if (!email) {
                showMessage('이메일을 입력해주세요.', 'error');
                return;
            }

            try {
                // 사용자 찾기
                const { data: users, error: userError } = await supabaseClient
                    .rpc('get_user_by_email', { user_email: email });

                if (userError || !users || users.length === 0) {
                    showMessage('해당 이메일의 사용자를 찾을 수 없습니다. 먼저 가입이 필요합니다.', 'error');
                    return;
                }

                const userId = users[0].id;

                // role을 student로 설정 + 이용권한 부여 (RPC 함수로 한번에 처리)
                const { error } = await supabaseClient
                    .rpc('grant_student_access', { target_user_id: userId });

                if (error) throw error;

                showMessage(`${email}에게 무료 이용 권한을 부여했습니다.`, 'success');
                document.getElementById('grant-email').value = '';
                await loadStudents();

            } catch (error) {
                console.error('Grant error:', error);
                showMessage('권한 부여 중 오류가 발생했습니다.', 'error');
            }
        }

        async function revokeAccess(userId) {
            if (!confirm('이 학생의 이용 권한을 제거하시겠습니까?')) return;

            try {
                const { error } = await supabaseClient
                    .from('user_purchases')
                    .update({ has_full_access: false })
                    .eq('user_id', userId);

                if (error) throw error;

                showMessage('권한이 제거되었습니다.', 'success');
                await loadStudents();

            } catch (error) {
                console.error('Revoke error:', error);
                showMessage('권한 제거 중 오류가 발생했습니다.', 'error');
            }
        }

        async function restoreAccess(userId) {
            try {
                const { error } = await supabaseClient
                    .from('user_purchases')
                    .update({ has_full_access: true })
                    .eq('user_id', userId);

                if (error) throw error;

                showMessage('권한이 복원되었습니다.', 'success');
                await loadStudents();

            } catch (error) {
                console.error('Restore error:', error);
                showMessage('권한 복원 중 오류가 발생했습니다.', 'error');
            }
        }

        function showMessage(text, type) {
            const el = document.getElementById('message');
            el.innerHTML = `<div class="message ${type}">${text}</div>`;
            setTimeout(() => el.innerHTML = '', 5000);
        }

        // 시작
        init();
    </script>
</body>
</html>
